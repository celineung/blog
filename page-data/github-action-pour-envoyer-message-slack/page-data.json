{"componentChunkName":"component---src-templates-post-js","path":"/github-action-pour-envoyer-message-slack","result":{"data":{"markdownRemark":{"html":"<h2>Qu'est-ce que les Github Actions ?</h2>\n<p>Les <a href=\"https://docs.github.com/en/actions\">Github Actions</a> permettent de déclarer des \"actions\" qui vont se déclencher automatiquement à certains moments de notre flux de travail.</p>\n<p>Par exemple, on peut définir une action qui va merger automatiquement une PR si elle a reçue au moins deux validations, ou encore une action qui va déplacer un ticket sur notre board Jira dès qu'une PR est mergée.</p>\n<p>Dans cet article, on va créer une Github Action qui envoie un message sur Slack contenant la version du <code class=\"language-text\">package.json</code> à chaque merge sur la branche dev.</p>\n<h2>Comment Github Actions fonctionne</h2>\n<ul>\n<li>\n<p>À la racine du projet, créer le dossier <code class=\"language-text\">.github/workflows</code></p>\n</li>\n<li>\n<p>Dans ce nouveau dossier, y créer le fichier <code class=\"language-text\">send-message-to-slack.yml</code> contenant:</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Send project version to Slack\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">send-message-to-slack</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Send message to Slack\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Retrieve version\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> retrieve<span class=\"token punctuation\">-</span>version\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          version=$(node -p \"require('./package.json').version\")\n          echo \"##[set-output name=version;]$version\"</span></code></pre></div>\n<p><strong>Que fait ce fichier ?</strong></p>\n<table>\n<thead>\n<tr>\n<th>Lignes du fichier</th>\n<th>Explications</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>name: Send project version to Slack</td>\n<td>Le nom du workflow qui apparaîtra dans l'onglet Actions de Github</td>\n</tr>\n<tr>\n<td>on:<br/>  push:<br/>    branches:<br/>      - master<br /></td>\n<td>Le workflow créé sera déclenché à chaque push sur la branche <code class=\"language-text\">master</code>. <br />Si comme moi vous travaillez sur une branche de développement et que vos commits sur master viennent de merges de la branche de développement, alors le workflow sera déclenché à chaque merge sur la branche <code class=\"language-text\">master</code>.</td>\n</tr>\n<tr>\n<td>jobs:</td>\n<td>Liste des jobs du workflow.<br />Un job liste un ensemble de <code class=\"language-text\">steps</code> qui se lancent sur le même serveur, appelé ici <code class=\"language-text\">runner</code>. Par défaut, les jobs déclarés démarrent en parallèle.</td>\n</tr>\n<tr>\n<td>send-message-to-slack:</td>\n<td>Nom du job.</td>\n</tr>\n<tr>\n<td>name: Send message to Slack</td>\n<td>Nom du job. Si spécifié, il s'agit alors de celui-ci qui sera affiché dans l'onglet Github.</td>\n</tr>\n<tr>\n<td>runs-on: ubuntu-latest</td>\n<td>Le job se lance sur une VM Linux hébergée par Github. Il est possible d'utiliser d'<a href=\"https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#jobsjob_idruns-on\">autres runners</a>.</td>\n</tr>\n<tr>\n<td>steps:</td>\n<td>Regroupe les <code class=\"language-text\">steps</code> du job <code class=\"language-text\">share-xpi</code>. Un step est soit une action (utilisé via le mot-clé <code class=\"language-text\">uses</code>), soit une commande shell (utilisé via le mot-clé <code class=\"language-text\">run</code>).<br />Dans notre exemple ici, nous avons 2 steps.</td>\n</tr>\n<tr>\n<td>- uses: actions/checkout@v2</td>\n<td>Le premier step de notre job utilise l'action <a href=\"https://github.com/marketplace/actions/checkout\">Checkout</a> du marketplace Github. Cette action va récupérer le repository et le télécharger sur le runner.</td>\n</tr>\n<tr>\n<td>- name: Retrieve version</td>\n<td>On attribue un nom plus explicite au deuxième step de notre job. Ce sera lui qui sera affiché dans notre onglet Github.</td>\n</tr>\n<tr>\n<td>id: retrieve-version</td>\n<td>J'attribue un id à ce step pour pouvoir récupérer son output dans la suite du job.</td>\n</tr>\n<tr>\n<td>run: |<br />version=$(node -p \"require('./package.json').version\")<br />echo \"##[set-output name=version;]$version\"</td>\n<td><code class=\"language-text\">run</code> indique ici que l'on va démarrer des commandes shell.<br />La barre vertical permet d'exécuter plusieurs commandes.<br /><br />La première ligne <code class=\"language-text\">version=$(node -p &quot;require(&#39;./package.json&#39;).version&quot;)</code> récupère la version du <code class=\"language-text\">package.json</code> dans une variable que l'on nomme <code class=\"language-text\">version</code>.<br /><br />La deuxième ligne <code class=\"language-text\">echo &quot;##[set-output name=version;]$version&quot;</code> stocke la variable précédente dans le step.</td>\n</tr>\n</tbody>\n</table>\n<p>Pour résumer: jusqu'à présent, nous nous sommes placés à l'intérieur de notre projet et avons récupéré sa version du <code class=\"language-text\">package.json</code>.</p>\n<p>Il nous reste maintenant à nous interfacer avec Slack pour lui envoyer notre message contenant le numéro de version.</p>\n<h2>Interfaçage avec Slack</h2>\n<h3>Créer un Github Action Secret contenant notre token Slack</h3>\n<p>Pour pouvoir nous connecter avec Slack, nous avons besoin de lui indiquer un token. Si vous n'en avez pas déjà un, il est possible d'en créer un <a href=\"https://1024pix.slack.com/apps/A0F7XDUAZ-incoming-webhooks\">ici</a>.</p>\n<p>Ensuite, il suffit de l'indiquer via les <a href=\"https://docs.github.com/en/actions/reference/encrypted-secrets#creating-encrypted-secrets-for-a-repository\">Github Action Secret</a>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/a63d79a04b640656912f9b51dc58de89/08485/github_repo_settings.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.594594594594593%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAxklEQVQY06WLy2rCQABF8yVVqAFtDGl8Ulx00b8t7uqimmQSH5/iphB1MpPMSCk9pVPpxqUXDvdw4Xqz5xd64YAwntDpRbT8gLbfpxsOeRzP6MdTgmhMPPnzaPRE2w+4u3+g1bnGmy8E80XG65vgPclZpYJlKkhFQb7ekRUbRLFxLpxvWaU5y0T88/txvyTDM59gvkCduSnfl/a01lhrUUphjEVWivJwdH6SFU1jOJ4kWteOxhi367pG6RpZVciy5GO/52wtP+u3+mRCrPTSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"onglet Settings du repository Github\"\n        title=\"onglet Settings du repository Github\"\n        src=\"/blog/static/a63d79a04b640656912f9b51dc58de89/fcda8/github_repo_settings.png\"\n        srcset=\"/blog/static/a63d79a04b640656912f9b51dc58de89/12f09/github_repo_settings.png 148w,\n/blog/static/a63d79a04b640656912f9b51dc58de89/e4a3f/github_repo_settings.png 295w,\n/blog/static/a63d79a04b640656912f9b51dc58de89/fcda8/github_repo_settings.png 590w,\n/blog/static/a63d79a04b640656912f9b51dc58de89/efc66/github_repo_settings.png 885w,\n/blog/static/a63d79a04b640656912f9b51dc58de89/c83ae/github_repo_settings.png 1180w,\n/blog/static/a63d79a04b640656912f9b51dc58de89/08485/github_repo_settings.png 2014w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Appelons ici le secret qui contient le token Slack <code class=\"language-text\">SLACK_TOKEN</code>.</p>\n<h3>Chercher une Github Action existante d'envoi de message Slack</h3>\n<p>Sur le marketplace de Github, il existe le Github Action <a href=\"https://github.com/marketplace/actions/slack-notify\">Slack Notify</a> qui nous permet d'envoyer un message Slack.</p>\n<p>Le fichier <code class=\"language-text\">send-message-to-slack.yml</code> devient finalement:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Send project version to Slack\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> master\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">send-message-to-slack</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Send message to Slack\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v2\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Retrieve version\n        <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> retrieve<span class=\"token punctuation\">-</span>version\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          version=$(node -p \"require('./package.json').version\")\n          echo \"##[set-output name=version;]$version\"</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Send Slack Notification\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> rtCamp/action<span class=\"token punctuation\">-</span>slack<span class=\"token punctuation\">-</span>notify@v2\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">MSG_MINIMAL</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n          <span class=\"token key atrule\">SLACK_CHANNEL</span><span class=\"token punctuation\">:</span> Updates\n          <span class=\"token key atrule\">SLACK_MESSAGE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"A new version has been deployed.\\nVersion: ${{steps.retrieve-version.outputs.version}}\"</span>\n          <span class=\"token key atrule\">SLACK_TITLE</span><span class=\"token punctuation\">:</span> Release v$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>steps.retrieve<span class=\"token punctuation\">-</span>version.outputs.version<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">SLACK_WEBHOOK</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SLACK_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Explications des nouvelles lignes</strong></p>\n<table>\n<thead>\n<tr>\n<th>Lignes du fichier</th>\n<th>Explications</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>- name: Send Slack Notification</td>\n<td>Nom du nouveau <code class=\"language-text\">step</code>.<br />Le job contient désormais trois <code class=\"language-text\">steps</code>.</td>\n</tr>\n<tr>\n<td>uses: rtCamp/action-slack-notify@v2</td>\n<td>Utilisation du Github Action: Slack Notify</td>\n</tr>\n<tr>\n<td>env:</td>\n<td>Contient les variables d'environnements nécessaires au fonctionnement de Slack Notify</td>\n</tr>\n<tr>\n<td>MSG_MINIMAL: true</td>\n<td>Slack Notify ajoute les informations <code class=\"language-text\">Ref</code>, <code class=\"language-text\">Event</code>, <code class=\"language-text\">Actions URL</code> et<code class=\"language-text\">Commit</code> au message. En mettant l'option <code class=\"language-text\">MSG_MINIMAL</code>, ces informations ne sont pas affichées.</td>\n</tr>\n<tr>\n<td>SLACK_CHANNEL: Updates</td>\n<td>Indique d'nvoyer le message au channel #Updates</td>\n</tr>\n<tr>\n<td>SLACK_MESSAGE: \"A new version has been deployed.\\nVersion: ${{steps.retrieve-version.outputs.version}}\"</td>\n<td>Définit le corps du message.<br />Remarquons ici que la sortie du step précédent est récupéré et injecté via <code class=\"language-text\">steps.[ID-DU-STEP].outputs.[NOM-DE-LA-VARIABLE]</code>.<br />La string est entouré de quote car un <code class=\"language-text\">\\n</code> y a été inséré pour indiquer un retour à la ligne.<br />Dommage, <code class=\"language-text\">SLACK_MESSAGE</code> ne comprend pas encore le markdown.</td>\n</tr>\n<tr>\n<td>SLACK_TITLE: Release v${{steps.retrieve-version.outputs.version}}</td>\n<td>Le titre du message Slack</td>\n</tr>\n<tr>\n<td>SLACK_WEBHOOK: ${{ secrets.SLACK_TOKEN }}</td>\n<td>Indiquer ici le token Slack ajouté à l'étape précédente dans les Action Secrets.</td>\n</tr>\n</tbody>\n</table>\n<p>Et voilà, nous avons notre Github Action qui envoit un message Slack !</p>\n<h2>Un autre exemple de Github Action</h2>\n<p>Pour voir un autre exemple, dans <a href=\"https://github.com/celineung/blog/blob/main/.github/workflows/auto-deploy.yml\">ce cas</a> j'ai mis en place une Github Action qui déploie un site statique sur gh-pages.</p>\n<p>Dans l'onglet \"Actions\" du repository, nous constatons que le workflow \"Autodeploy\" a été lancé avec succès sur le commit \"[MERGE] Add Github Action to auto deploy\" de la branche <code class=\"language-text\">main</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/2c5fcc1904aaaa62e77f5020142dc79f/e8950/github_repo_actions.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.43243243243243%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA/klEQVQY05WRvU7EQAyE88rU8AL0vMQJREGBaOgogYoWnXS5kIs4kuxustn/D+1GgOjA0si2PLLGngoCv+HphxElJKrvsVpjrC1w3uO9xxiLdQ5rXaljSoQYCSFQbR5qbp4/uHySXNwfedxOqLFnVzdIqfhvVOe3HWdXNafXLSebA3cvqiidtGFZDN6HvyMrhAQ41rzGcRC03TtqXjAusFj/DWM9Qk0INTMIVfIoJ6SakZOmimldFSL4kMh9J4+8brc0Tcuu3tO8tbSHjnq/RyiNdqkISInyu2EUTLMmhEiVUh78AFZSPjc/3WZDzFpnY2KMxYQvfoypcLIhuf8Ea+HPCWC7YOUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"onglet Actions du repository Github\"\n        title=\"onglet Actions du repository Github\"\n        src=\"/blog/static/2c5fcc1904aaaa62e77f5020142dc79f/fcda8/github_repo_actions.png\"\n        srcset=\"/blog/static/2c5fcc1904aaaa62e77f5020142dc79f/12f09/github_repo_actions.png 148w,\n/blog/static/2c5fcc1904aaaa62e77f5020142dc79f/e4a3f/github_repo_actions.png 295w,\n/blog/static/2c5fcc1904aaaa62e77f5020142dc79f/fcda8/github_repo_actions.png 590w,\n/blog/static/2c5fcc1904aaaa62e77f5020142dc79f/efc66/github_repo_actions.png 885w,\n/blog/static/2c5fcc1904aaaa62e77f5020142dc79f/c83ae/github_repo_actions.png 1180w,\n/blog/static/2c5fcc1904aaaa62e77f5020142dc79f/e8950/github_repo_actions.png 2000w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>","excerpt":"Qu'est-ce que les Github Actions ? Les Github Actions permettent de déclarer des \"actions\" qui vont se déclencher automatiquement à certains…","frontmatter":{"date":"2021-02-19","slug":"github-action-pour-envoyer-message-slack","title":"Ajout de Github Action pour envoyer un message sur Slack","illustration":{"childImageSharp":{"resize":{"src":"/static/43d7c7f3d3545e44d86167dcec5fe61e/47498/journal-and-coffee-at-table.jpg","height":800,"width":1200}}}}}},"pageContext":{"slug":"github-action-pour-envoyer-message-slack"}},"staticQueryHashes":["3649515864","764694655"]}